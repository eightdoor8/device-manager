# Device Manager - アプリ仕様書

**プロジェクト名**: Device Manager（モバイル端末管理アプリ）  
**バージョン**: 1.0.0  
**作成日**: 2025-12-20  
**対象読者**: QAエンジニア  
**ドキュメント種別**: 標準版（機能詳細、画面遷移、データモデル）

---

## 目次

1. [機能概要](#機能概要)
2. [システムアーキテクチャ](#システムアーキテクチャ)
3. [画面一覧と画面遷移](#画面一覧と画面遷移)
4. [各画面の詳細説明](#各画面の詳細説明)
5. [データモデル](#データモデル)
6. [機能仕様](#機能仕様)
7. [エラーハンドリング](#エラーハンドリング)

---

## 機能概要

### アプリの目的

Device Manager は、社内QAチームが業務で使用するモバイル端末を効率的に管理するためのアプリです。端末の登録、貸出・返却、検索・フィルタ機能を提供し、複数のQAエンジニアが端末を共有する際の運用を支援します。

### 主要機能

| 機能 | 説明 |
|------|------|
| **認証機能** | メールアドレスとパスワードによるログイン・新規登録 |
| **端末登録** | 端末情報の自動取得と手動入力による登録 |
| **端末一覧** | 登録済み端末の一覧表示 |
| **検索・フィルタ** | 機種名、OSバージョン、メーカーでの検索・フィルタ |
| **貸出・返却** | 端末の貸出・返却ステータス管理 |
| **排他制御** | 複数ユーザーによる同時借用の防止 |
| **ユーザー管理** | プロフィール表示、ログアウト |

### ユーザー権限

| 権限 | 説明 |
|------|------|
| **Admin（管理者）** | 全機能へのアクセス、端末削除可能 |
| **User（一般）** | 端末登録、貸出・返却、検索機能へのアクセス |

---

## システムアーキテクチャ

### 技術スタック

| 層 | 技術 |
|------|------|
| **Frontend** | React Native (Expo SDK 54) + TypeScript |
| **Backend** | Firebase (Authentication, Firestore) |
| **State Management** | React Hooks + Context API |
| **UI Framework** | React Native + TailwindCSS |

### システム構成図

```
┌─────────────────────────────────────────────────────────┐
│                   Device Manager App                    │
│                   (React Native)                        │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
    ┌───▼────┐   ┌────▼────┐   ┌────▼────┐
    │ Auth   │   │Firestore│   │ Storage │
    │Module  │   │Database │   │(Images) │
    └────────┘   └─────────┘   └─────────┘
        │              │              │
        └──────────────┼──────────────┘
                       │
            ┌──────────▼──────────┐
            │  Firebase Services  │
            │  (Authentication,   │
            │   Firestore, etc)   │
            └─────────────────────┘
```

---

## 画面一覧と画面遷移

### 画面一覧

| 画面ID | 画面名 | 説明 |
|--------|--------|------|
| SCR-001 | ログイン画面 | メールアドレスとパスワードでログイン |
| SCR-002 | 新規登録画面 | 新しいアカウントを作成 |
| SCR-003 | ホーム画面（端末一覧） | 登録済み端末の一覧表示 |
| SCR-004 | 端末登録画面 | 新しい端末を登録 |
| SCR-005 | 端末詳細画面 | 端末の詳細情報と貸出・返却操作 |
| SCR-006 | マイデバイス画面 | 自分が借りている端末の一覧 |
| SCR-007 | プロフィール画面 | ユーザー情報の表示とログアウト |

### 画面遷移図

```
                    ┌─────────────────┐
                    │  ログイン画面   │
                    │  (SCR-001)      │
                    └────────┬────────┘
                             │
                ┌────────────┼────────────┐
                │            │            │
           ログイン      新規登録      パスワード忘却
                │            │
                │    ┌───────▼────────┐
                │    │ 新規登録画面   │
                │    │ (SCR-002)      │
                │    └────────┬───────┘
                │             │
                │        登録完了
                │             │
                └─────┬───────┘
                      │
            ┌─────────▼──────────┐
            │  ホーム画面        │
            │  (SCR-003)         │
            │ ┌────────────────┐ │
            │ │ 端末一覧       │ │
            │ │ 検索・フィルタ │ │
            │ │ ＋追加ボタン   │ │
            │ └────────────────┘ │
            └─────────┬──────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        │             │             │
    ┌───▼────┐   ┌───▼────┐   ┌───▼────┐
    │端末詳細 │   │端末登録 │   │マイデバ│
    │(SCR-005)   │(SCR-004)   │イス    │
    │        │   │        │   │(SCR-006)
    │・借りる │   │・情報入力   │        │
    │・返す   │   │・登録   │   │        │
    │・削除   │   │・キャンセル │        │
    └────────┘   └────────┘   └────────┘
        │             │             │
        └─────────────┼─────────────┘
                      │
            ┌─────────▼──────────┐
            │ プロフィール画面   │
            │ (SCR-007)          │
            │ ・ユーザー情報表示 │
            │ ・ログアウト       │
            └────────┬───────────┘
                     │
                ログアウト
                     │
            ┌────────▼──────────┐
            │ ログイン画面      │
            │ (SCR-001)         │
            └───────────────────┘
```

---

## 各画面の詳細説明

### SCR-001: ログイン画面

**画面の目的**: ユーザーの認証

**画面構成**:
- ヘッダー: アプリロゴ、「Device Manager」タイトル
- メールアドレス入力フィールド
- パスワード入力フィールド
- 「ログイン」ボタン
- 「新規登録」リンク
- 「パスワードを忘れた」リンク（将来実装予定）

**入力項目**:

| 項目 | 型 | 必須 | バリデーション |
|------|-----|------|----------------|
| メールアドレス | テキスト | ○ | メール形式 |
| パスワード | パスワード | ○ | 6文字以上 |

**ボタン動作**:

| ボタン | 動作 | 遷移先 |
|--------|------|--------|
| ログイン | Firebase Authenticationで認証 | ホーム画面（成功時）、エラー表示（失敗時） |
| 新規登録 | 新規登録画面に遷移 | SCR-002 |

**エラーメッセージ**:
- 「メールアドレスまたはパスワードが正しくありません」
- 「メールアドレスが登録されていません」
- 「ネットワークエラーが発生しました」

---

### SCR-002: 新規登録画面

**画面の目的**: 新しいユーザーアカウントの作成

**画面構成**:
- ヘッダー: 「新規登録」タイトル
- メールアドレス入力フィールド
- パスワード入力フィールド
- パスワード確認入力フィールド
- 「登録」ボタン
- 「キャンセル」ボタン

**入力項目**:

| 項目 | 型 | 必須 | バリデーション |
|------|-----|------|----------------|
| メールアドレス | テキスト | ○ | メール形式、重複チェック |
| パスワード | パスワード | ○ | 6文字以上 |
| パスワード確認 | パスワード | ○ | パスワードと一致 |

**ボタン動作**:

| ボタン | 動作 | 遷移先 |
|--------|------|--------|
| 登録 | Firebase Authenticationでユーザー作成、Firestoreにユーザードキュメント作成 | ホーム画面（成功時）、エラー表示（失敗時） |
| キャンセル | 入力内容を破棄 | ログイン画面 |

**エラーメッセージ**:
- 「メールアドレスが既に登録されています」
- 「パスワードが一致しません」
- 「パスワードは6文字以上である必要があります」
- 「登録に失敗しました」

---

### SCR-003: ホーム画面（端末一覧）

**画面の目的**: 登録済み端末の一覧表示と管理

**画面構成**:
- ヘッダー: 「Device Manager」タイトル、ユーザーアイコン
- 検索バー（機種名で検索）
- フィルタボタン（OS、メーカー、ステータス）
- 端末カードリスト
- 「＋追加」ボタン（フローティング）
- ボトムタブ: ホーム、マイデバイス、プロフィール

**端末カード表示項目**:

| 項目 | 説明 |
|------|------|
| 機種名 | 例：iPhone 14 Pro Max |
| OSバージョン | 例：iOS 17.2 |
| 画面サイズ | 例：6.7インチ |
| ステータス | 「利用可」（緑）/ 「貸出中」（赤） |
| 利用者名 | 貸出中の場合のみ表示 |

**検索・フィルタ機能**:

| 機能 | 説明 |
|------|------|
| 検索 | 機種名で部分一致検索 |
| フィルタ（OS） | iOS / Android で絞り込み |
| フィルタ（メーカー） | Apple / Samsung / その他で絞り込み |
| フィルタ（ステータス） | 利用可 / 貸出中で絞り込み |

**ボタン動作**:

| ボタン/操作 | 動作 | 遷移先 |
|------------|------|--------|
| 端末カード | 端末詳細画面を表示 | SCR-005 |
| ＋追加 | 端末登録画面を表示 | SCR-004 |
| マイデバイスタブ | マイデバイス画面に遷移 | SCR-006 |
| プロフィールタブ | プロフィール画面に遷移 | SCR-007 |

---

### SCR-004: 端末登録画面

**画面の目的**: 新しい端末の登録

**画面構成**:
- ヘッダー: 「端末登録」タイトル
- 自動検出情報セクション（読み取り専用）
  - OS名
  - OSバージョン
  - 内部モデルID
  - メーカー
  - UUID
  - 物理メモリ
- 編集可能項目セクション
  - 機種名（必須）
  - 画面サイズ
  - メモ
- 「登録」ボタン
- 「キャンセル」ボタン

**入力項目**:

| 項目 | 型 | 必須 | バリデーション |
|------|-----|------|----------------|
| 機種名 | テキスト | ○ | 1～100文字 |
| 画面サイズ | テキスト | × | 1～50文字 |
| メモ | テキスト | × | 1～500文字 |

**ボタン動作**:

| ボタン | 動作 | 遷移先 |
|--------|------|--------|
| 登録 | Firestoreにデバイスドキュメント作成 | ホーム画面（成功時）、エラー表示（失敗時） |
| キャンセル | 入力内容を破棄 | ホーム画面 |

**エラーメッセージ**:
- 「必須項目を入力してください」
- 「端末の登録に失敗しました」
- 「ネットワークエラーが発生しました」

---

### SCR-005: 端末詳細画面

**画面の目的**: 端末の詳細情報表示と貸出・返却操作

**画面構成**:
- ヘッダー: 「端末詳細」タイトル、戻るボタン
- 端末情報セクション
  - 機種名
  - OSバージョン
  - 画面サイズ
  - メーカー
  - UUID
  - 物理メモリ
  - メモ
- ステータスセクション
  - ステータス（利用可 / 貸出中）
  - 利用者名（貸出中の場合）
  - 貸出日時（貸出中の場合）
- アクションボタン
  - 「借りる」ボタン（ステータスが「利用可」の場合のみ表示・有効）
  - 「返す」ボタン（ステータスが「貸出中」かつ現在のユーザーが利用者の場合のみ表示・有効）
  - 「削除」ボタン（管理者のみ表示）

**ボタン動作**:

| ボタン | 動作 | 条件 |
|--------|------|------|
| 借りる | ステータスを「貸出中」に変更、利用者を現在のユーザーに設定 | ステータスが「利用可」、他のユーザーが借りていない |
| 返す | ステータスを「利用可」に変更、利用者をクリア | ステータスが「貸出中」、現在のユーザーが利用者 |
| 削除 | 端末ドキュメントをFirestoreから削除 | 管理者権限 |

**エラーメッセージ**:
- 「この端末は既に他のユーザーが借りています」
- 「貸出に失敗しました」
- 「返却に失敗しました」
- 「削除に失敗しました」

---

### SCR-006: マイデバイス画面

**画面の目的**: 現在のユーザーが借りている端末の一覧表示

**画面構成**:
- ヘッダー: 「マイデバイス」タイトル
- 借りている端末カードリスト
- ボトムタブ: ホーム、マイデバイス、プロフィール

**表示項目**:
- 機種名
- OSバージョン
- 画面サイズ
- 貸出日時

**ボタン動作**:

| ボタン/操作 | 動作 | 遷移先 |
|------------|------|--------|
| 端末カード | 端末詳細画面を表示 | SCR-005 |
| ホームタブ | ホーム画面に遷移 | SCR-003 |
| プロフィールタブ | プロフィール画面に遷移 | SCR-007 |

---

### SCR-007: プロフィール画面

**画面の目的**: ユーザー情報の表示とログアウト

**画面構成**:
- ヘッダー: 「プロフィール」タイトル
- ユーザー情報セクション
  - メールアドレス
  - ユーザー名（登録時のメールアドレスから自動生成）
  - 権限（Admin / User）
- 「ログアウト」ボタン
- ボトムタブ: ホーム、マイデバイス、プロフィール

**ボタン動作**:

| ボタン | 動作 | 遷移先 |
|--------|------|--------|
| ログアウト | Firebase Authenticationからログアウト、ユーザー情報をクリア | ログイン画面 |
| ホームタブ | ホーム画面に遷移 | SCR-003 |
| マイデバイスタブ | マイデバイス画面に遷移 | SCR-006 |

---

## データモデル

### Firestore コレクション構成

```
device-manager-c2454 (Firestore Database)
├── users/
│   ├── {userId}
│   │   ├── email: string
│   │   ├── name: string
│   │   ├── role: string (admin | user)
│   │   ├── createdAt: timestamp
│   │   └── updatedAt: timestamp
│   └── ...
└── devices/
    ├── {deviceId}
    │   ├── modelName: string
    │   ├── internalModelId: string
    │   ├── osName: string
    │   ├── osVersion: string
    │   ├── manufacturer: string
    │   ├── screenSize: string
    │   ├── physicalMemory: string
    │   ├── uuid: string
    │   ├── status: string (available | in_use)
    │   ├── currentUserId: string (null if available)
    │   ├── currentUserName: string (null if available)
    │   ├── borrowedAt: timestamp (null if available)
    │   ├── memo: string
    │   ├── registeredBy: string
    │   ├── registeredAt: timestamp
    │   └── updatedAt: timestamp
    └── ...
```

### ユーザードキュメント

```json
{
  "email": "user@example.com",
  "name": "user",
  "role": "user",
  "createdAt": "2025-12-20T10:30:00Z",
  "updatedAt": "2025-12-20T10:30:00Z"
}
```

### デバイスドキュメント

```json
{
  "modelName": "iPhone 14 Pro Max",
  "internalModelId": "iPhone15,3",
  "osName": "iOS",
  "osVersion": "17.2",
  "manufacturer": "Apple",
  "screenSize": "6.7インチ",
  "physicalMemory": "6GB",
  "uuid": "550e8400-e29b-41d4-a716-446655440000",
  "status": "available",
  "currentUserId": null,
  "currentUserName": null,
  "borrowedAt": null,
  "memo": "テスト用端末",
  "registeredBy": "user123",
  "registeredAt": "2025-12-20T10:30:00Z",
  "updatedAt": "2025-12-20T10:30:00Z"
}
```

### ステータス遷移図

```
┌──────────────┐
│   available  │ (利用可)
│ (初期状態)   │
└──────┬───────┘
       │
       │ 「借りる」操作
       │
       ▼
┌──────────────┐
│   in_use     │ (貸出中)
│              │
└──────┬───────┘
       │
       │ 「返す」操作
       │
       ▼
┌──────────────┐
│   available  │ (利用可)
└──────────────┘
```

---

## 機能仕様

### 認証機能

#### ログイン

**処理フロー**:
1. ユーザーがメールアドレスとパスワードを入力
2. Firebase Authenticationで認証
3. 認証成功時、ホーム画面に遷移
4. 認証失敗時、エラーメッセージを表示

**バリデーション**:
- メールアドレス: メール形式
- パスワード: 6文字以上

#### 新規登録

**処理フロー**:
1. ユーザーがメールアドレス、パスワード、パスワード確認を入力
2. バリデーション実行
3. Firebase Authenticationでユーザー作成
4. Firestoreの `users` コレクションにユーザードキュメント作成
5. 登録成功時、ホーム画面に遷移
6. 登録失敗時、エラーメッセージを表示

**バリデーション**:
- メールアドレス: メール形式、重複チェック
- パスワード: 6文字以上
- パスワード確認: パスワードと一致

### 端末登録機能

#### 端末情報自動取得

**取得情報**:
- OS名（iOS / Android）
- OSバージョン
- 内部モデルID
- メーカー
- UUID
- 物理メモリ

**実装方法**:
- `expo-device` パッケージを使用
- 実機でのみ取得可能（シミュレーター/エミュレーターでは取得不可）

#### モデル名マッピング

**処理**:
1. 内部モデルIDを取得
2. ローカルのマッピングテーブルから対応する機種名を検索
3. マッピングが存在しない場合、「Unknown Device (iPhone16,1)」のように表示

**マッピングテーブル**:
- `data/ios-models.json`: iOSモデルのマッピング
- `data/android-models.json`: Androidモデルのマッピング

#### 端末登録処理

**処理フロー**:
1. 端末情報を自動取得
2. ユーザーが機種名、画面サイズ、メモを入力
3. 「登録」ボタンをタップ
4. Firestoreの `devices` コレクションにデバイスドキュメント作成
5. ステータスを「available」に設定
6. 登録成功時、ホーム画面に遷移
7. 登録失敗時、エラーメッセージを表示

### 端末一覧・検索・フィルタ機能

#### 端末一覧表示

**処理フロー**:
1. Firestoreから全デバイスドキュメントを取得
2. 更新日時の降順でソート
3. 端末カードとして表示

#### 検索機能

**処理フロー**:
1. ユーザーが検索キーワードを入力
2. 機種名、OSバージョン、メーカーで部分一致検索（クライアント側）
3. マッチした端末のみを表示

#### フィルタ機能

**フィルタ項目**:
- OS（iOS / Android）
- メーカー（Apple / Samsung / その他）
- ステータス（利用可 / 貸出中）

**処理フロー**:
1. ユーザーがフィルタ条件を選択
2. Firestoreから条件に合致するデバイスドキュメントを取得
3. マッチした端末のみを表示

### 貸出・返却機能

#### 貸出処理

**処理フロー**:
1. ユーザーが端末詳細画面で「借りる」ボタンをタップ
2. 排他制御チェック（ステータスが「available」か確認）
3. ステータスを「in_use」に変更
4. `currentUserId` を現在のユーザーIDに設定
5. `currentUserName` を現在のユーザー名に設定
6. `borrowedAt` を現在の日時に設定
7. 成功メッセージを表示
8. 端末詳細画面を更新

**排他制御**:
- ステータスが「in_use」の場合、「借りる」ボタンを無効化
- 複数ユーザーによる同時借用を防止

#### 返却処理

**処理フロー**:
1. ユーザーが端末詳細画面で「返す」ボタンをタップ
2. 権限チェック（現在のユーザーが利用者か確認）
3. ステータスを「available」に変更
4. `currentUserId` を null に設定
5. `currentUserName` を null に設定
6. `borrowedAt` を null に設定
7. 成功メッセージを表示
8. 端末詳細画面を更新

**権限チェック**:
- 現在のユーザーが利用者でない場合、「返す」ボタンを無効化
- 借りたユーザーのみが返却可能

---

## エラーハンドリング

### エラー分類

| エラー分類 | 例 | ユーザーへの通知 |
|-----------|-----|-----------------|
| **認証エラー** | ログイン失敗、ユーザー作成失敗 | スナックバー / アラート |
| **ネットワークエラー** | 通信断絶、タイムアウト | スナックバー / アラート |
| **Firebaseエラー** | Firestore操作失敗 | スナックバー / アラート |
| **バリデーションエラー** | 入力値が不正 | インラインエラー / アラート |
| **権限エラー** | 管理者権限が必要 | スナックバー / アラート |

### エラーメッセージ例

**認証エラー**:
- 「メールアドレスまたはパスワードが正しくありません」
- 「メールアドレスが既に登録されています」
- 「ログインに失敗しました」

**ネットワークエラー**:
- 「ネットワークエラーが発生しました」
- 「通信がタイムアウトしました」

**Firebaseエラー**:
- 「端末の登録に失敗しました」
- 「貸出に失敗しました」
- 「返却に失敗しました」

**バリデーションエラー**:
- 「必須項目を入力してください」
- 「メールアドレスの形式が正しくありません」
- 「パスワードは6文字以上である必要があります」

### エラー処理フロー

```
ユーザー操作
    │
    ▼
エラー発生？
    │
    ├─ Yes → エラー分類
    │         │
    │         ├─ 認証エラー → Firebase エラーメッセージ
    │         ├─ ネットワークエラー → 「ネットワークエラーが発生しました」
    │         ├─ Firebaseエラー → 「操作に失敗しました」
    │         ├─ バリデーションエラー → 具体的なエラーメッセージ
    │         └─ 権限エラー → 「権限がありません」
    │
    │         エラーメッセージ表示（スナックバー/アラート）
    │         │
    │         ▼
    │         ユーザーに通知
    │
    └─ No → 処理成功
            │
            ▼
            成功メッセージ表示
            │
            ▼
            画面遷移 / 画面更新
```

---

## 非機能要件

### パフォーマンス

| 項目 | 要件 |
|------|------|
| 画面読み込み時間 | 2秒以内 |
| 検索応答時間 | 1秒以内 |
| 端末一覧読み込み | 3秒以内 |

### セキュリティ

| 項目 | 要件 |
|------|------|
| 認証 | Firebase Authentication（メール/パスワード） |
| 通信 | HTTPS（Firebase提供） |
| データ保護 | Firestoreセキュリティルール |
| パスワード | 6文字以上、暗号化保存 |

### 可用性

| 項目 | 要件 |
|------|------|
| 対応OS | iOS 14.0以上、Android 8.0以上 |
| オフライン対応 | 限定的（ログイン後の操作は要ネットワーク） |
| バックアップ | Firestore自動バックアップ |

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 1.0.0 | 2025-12-20 | 初版作成 |

---

**ドキュメント作成者**: AI Assistant  
**最終更新日**: 2025-12-20  
**バージョン**: 1.0.0
