# Device Manager TODO

## プロジェクト初期設定
- [ ] アプリロゴの生成とブランディング設定
- [ ] テーマカラーの設定

## Firebase設定
- [x] Firebase SDKのインストール
- [x] Firebase設定ファイルの作成
- [x] Firestore データモデルの定義
- [x] Firebase Authentication設定

## 端末情報自動取得機能
- [x] expo-device パッケージのインストール
- [x] 端末情報取得ユーティリティの作成
- [x] iOSモデル名マッピングデータの作成
- [x] Androidモデル名マッピングデータの作成
- [x] モデル名変換ロジックの実装

## 認証機能
- [x] ログイン画面の実装
- [x] Firebase Authentication統合
- [x] ユーザー権限管理（Admin/User）の実装
- [x] 認証状態管理フックの作成

## 端末一覧・検索機能
- [x] 端末一覧画面の実装
- [x] DeviceCardコンポーネントの作成
- [x] StatusBadgeコンポーネントの作成
- [x] 検索機能の実装
- [x] フィルタモーダルの実装
- [x] FilterChipコンポーネントの作成
- [x] Firestoreからのデータ取得

## 端末詳細・貸出機能
- [x] 端末詳細画面の実装
- [x] DetailRowコンポーネントの作成
- [x] 「借りる」機能の実装
- [x] 「返す」機能の実装
- [x] 排他制御ロジックの実装
- [x] 確認ダイアログの実装

## 端末登録機能
- [x] 端末登録画面の実装
- [x] 自動検出情報の表示
- [x] 手動入力フォームの実装
- [x] Firestoreへのデータ保存

## マイデバイス機能
- [x] マイデバイスタブの実装
- [x] 自分が借りている端末の一覧表示

## プロフィール機能
- [x] プロフィールタブの実装
- [x] ユーザー情報表示
- [x] ログアウト機能

## エラーハンドリング
- [x] エラー表示コンポーネントの作成
- [x] 通信エラーハンドリング
- [x] バリデーションエラー表示
- [x] スナックバー/トースト実装

## UI/UX改善
- [x] ローディングインジケーターの実装
- [x] アニメーション追加
- [x] ハプティックフィードバック
- [x] ダークモード対応確認

## テスト
- [x] 端末情報取得ロジックのテスト
- [x] 貸出・返却ロジックのテスト
- [x] 認証フローのテスト

## ドキュメント
- [x] README更新
- [x] Firebase設定手順書作成
- [x] 開発者向けドキュメント作成

## 完了済み
- [x] アプリロゴの生成とブランディング設定
- [x] テーマカラーの設定


## バグ修正
- [x] Android 15でのアプリクラッシュ問題を修正
- [x] Firebase初期化エラーの確認と修正
- [x] 環境変数読み込みエラーの確認と修正
- [x] Firebase設定情報の登録と検証


## 新規バグ報告
- [x] 端末登録画面で「＋追加」ボタンをタップしても端末が追加されない
- [x] ネットワークエラー時のエラーメッセージ改善（「認証に失敗しました」→「ネットワーク接続エラー」）
- [x] 別端末での端末登録画面が表示されない問題を修正

- [x] 端末登録ボタンをタップしても、端末登録画面に遭移しない問題を修正

## 新規バグ報告（現在対応中）
- [ ] 重複登録防止機能を修正
- [x] 端末削除機能を実装
- [ ] マイデバイス欄に借りた端末が表示されない問題を修正

## 新規バグ報告2（現在対応中）
- [x] マイデバイス欄に借りた端末が表示されない
- [x] 返すボタンと削除ボタンがくっついて表示されている
- [x] 端末一覧画面のフィルタ機能が効いていないを修正
- [x] 検索画面に検索ボタンを追加し、検索実行を明確化


## 新規## 新規バグ報告3（完了）

## 次回実装予定
- [ ] Web管理画面の作成
  - [ ] 端末一覧画面の実装
  - [ ] CSV出力機能の実装
  - [ ] ユーザー管理機能の実装
- [ ] 並び順修正（利用可を上部に表示）
- [x] バージョン1.0.7でアプリを開くとクラッシュする問題を修正
- [x] ログイン時のメール形式チェックでFirebaseのエラーメッセージがそのまま表示される
- [x] 検索機能の改善：「15」で「Android15」と「iPhone15」の両方がヒットする問題
- [x] 実務的なフィルタ機能の追加：OSやメーカーでフィルターがかけられるようにする


## リアルタイム更新機能（現在対応中）
- [x] Firestoreリアルタイムリスナーの実装
  - [x] DeviceContextの作成
  - [x] ホーム画面でDeviceContextを使用
  - [x] 端末詳細画面で楽観的更新を実装
  - [x] マイデバイス画面でDeviceContextを使用
  - [x] 追加・ステータス変更・削除時に即座に画面更新

## イベント駆動型更新実装（現在対応中）
- [x] DeviceContextの定期同期廃止
  - [x] 10秒ごとの定期同期を削除
  - [x] syncSingleDeviceメソッドを追加
- [x] 端末詳細画面での操作完了後同期
  - [x] handleBorrow完了後にsyncSingleDeviceを呼び出し
  - [x] handleReturn完了後にsyncSingleDeviceを呼び出し
- [x] 端末登録画面での登録完了後同期
  - [x] 登録完了後にsyncDevicesを呼び出し
- [x] マイデバイス画面のDeviceContext統合
  - [x] useUserDevicesRealtimeを削除
  - [x] DeviceContextを使用するように変更
  - [x] 自分が借りている端末のみフィルタ

## 端末一覧画面のソート処理実装
- [x] 端末一覧画面にソート処理を追加
  - [x] 利用可 → 貸出中の順でソート
  - [x] データ更新時に自動的にソートを再実行


## QA不具合・要望対応（現在対応中）

### ログイン画面
- [x] パスワードマスク解除ボタンの追加
- [x] 未登録アドレス・パスワード不一致時のエラー表示改善（Firebaseエラーを非表示にする）

### 端末登録画面
- [x] 内部モデルID（internalModelId）の削除
- [ ] AndroidのUUID欄の表記改善（ビルド番号ではなくUUIDを取得）
- [ ] iOSのUDID取得の検討
- [x] 必須項目の表示改善（「*」から「必須」への変更）
- [x] 必須項目未入力エラー時の視覺的フィールドバック（赤字・赤枕）

### 端末削除機能
- [x] 貸出中の端末は削除不可にする（削除ボタンを非活性化）


## QA指摘事項の修正（現在対応中）
- [x] 端末詳細画面の内部モデルID項目を削除
- [x] 端末登録画面の「*必須、上記以外は任意」注釈を削除
- [x] パスワードマスク切り替えを目のアイコンに変更（Material Icons）

## Firebase初期化エラーハンドリングの改善
- [x] Firebase設定不完全時のエラーハンドリングを改善
  - [x] 初期化エラー時に例外をthrowしないように修正
  - [x] アプリ全体がクラッシュしないように改善


## WEB管理画面の実装（現在対応中）

### Phase 1: メール・パスワード認証の実装
- [x] bcryptをインストール
- [x] db.tsに`createUserWithPassword`関数を追加
- [x] routers.tsに`auth.register`エンドポイントを追加
- [x] WEB管理画面にユーザー登録フォームを追加
- [x] tRPCのHTTP API問題を修正
- [x] テストユーザーを作成
- [x] ログイン・ログアウト機能を検証

### Phase 2: ダッシュボード画面の実装
- [x] ログイン後のダッシュボード画面を実装
- [x] デバイス一覧表示機能
- [x] サイドバーナビゲーションの実装
- [x] ヘッダーの実装

### Phase 3: デバイス管理機能の実装
- [ ] デバイス登録機能
- [ ] デバイス削除機能
- [ ] ユーザー管理機能
- [ ] CSV出力機能

### Phase 4: テストと検証
- [ ] ログイン/ログアウト動作確認
- [ ] ユーザー登録機能テスト
- [ ] デバイス管理機能テスト
- [ ] CSV出力テスト

### Phase 5: 最終Checkpoint作成
- [ ] Checkpointを作成
- [ ] ユーザーへの成果物配信

## 現在対応中：セッション保持機能の実装

### 完了：ログイン機能の問題修正
- [x] バックエンドサーバーの状態確認
- [x] Viteプロキシ設定の確認
- [x] tRPC API_URLを相対パスに変更
- [x] ログイン機能が動作確認

### Phase 1: ダッシュボードのナビゲーション機能実装
- [x] React Routerをインストール
- [x] ルーティング設定を実装
- [x] ダッシュボード画面を修正

### Phase 2: デバイス一覧表示画面の実装
- [x] Devices.tsxを作成
- [x] デバイス一覧を表示
- [x] ソート・フィルタ機能を実装
- [x] PC表示に最適化
- [x] ダッシュボードカードをクリック可能に
- [x] 全体デザインをAIプロダクトっぽく洗練
- [x] 利用可能な端末カードをクリック時にフィルタを適用

### Phase 2.5: Firebase統合
- [ ] Firebase Admin SDKをインストール
- [ ] Firebaseからデバイス情報を取得
- [ ] Firebaseからユーザー情報を取得
- [ ] WEB管理画面に表示

### Phase 3: ユーザー管理画面の実装
- [ ] Users.tsxを作成
- [ ] ユーザー一覧を表示
- [ ] ユーザー役割変更機能を実装

### Phase 4: 設定画面の実装
- [ ] Settings.tsxを作成
- [ ] 基本的な設定画面を実装

### Phase 5: セッション保持機能とエラーハンドリングの改善
- [ ] auth.meエンドポイントを修正
- [ ] クッキーベースのセッション管理を実装
- [ ] エラーハンドリングを改善

### Phase 6: 全体テストと最終Checkpoint作成
- [ ] 全機能の動作確認
- [ ] 最終Checkpointを作成


## 貸出履歴自動ログ化プロジェクト（完了）

### バックエンド実装
- [x] RentalHistory スキーマを確認・修正（自動ログ用に再設計）
- [x] デバイスステータス変更時に自動ログ記録機能を実装
- [x] tRPC エンドポイント：rentalHistory.list を確認・修正
- [x] 履歴削除ロジック：最新100件を保持し、古い履歴を自動削除

### Androidアプリ側
- [x] 貸出ボタン：デバイスステータスを「in_use」に更新
- [x] 返却ボタン：デバイスステータスを「available」に更新
- [x] バックエンドが自動的にログを記録することを確認

### WEB管理画面
- [x] 「+ 貸出を記録」ボタンを削除
- [x] RentalHistory.tsx を修正：手動入力フォームを削除
- [x] 貸出履歴テーブルを読み取り専用に変更
- [x] フィルタ・検索機能は維持

### テスト・検証
- [x] バックエンド：自動ログ記録が正常に動作することを確認
- [x] Androidアプリ：貸出・返却操作でログが記録されることを確認
- [x] WEB管理画面：履歴が正常に表示されることを確認
- [x] デグレがないか全ページで確認

### デプロイ
- [ ] チェックポイント作成
- [ ] Vercel にデプロイ（QA用固定URL取得）
