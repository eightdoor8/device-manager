# Device Manager WEB管理画面 仕様書

**作成日：** 2026年1月14日  
**バージョン：** 1.0  
**作成者：** Manus AI

---

## 目次

1. [概要](#概要)
2. [システムアーキテクチャ](#システムアーキテクチャ)
3. [認証とセキュリティ](#認証とセキュリティ)
4. [画面構成](#画面構成)
5. [各画面の詳細仕様](#各画面の詳細仕様)
6. [API仕様](#api仕様)
7. [データベース仕様](#データベース仕様)
8. [ユーザーロール権限](#ユーザーロール権限)

---

## 概要

**Device Manager WEB管理画面** は、QAチーム向けのテスト端末管理システムです。本システムは、テスト用スマートフォン・タブレット等の端末の貸出・返却管理、ユーザー管理、および全体のダッシュボード表示を提供します。

### 主な機能

Device Manager WEB管理画面は以下の主要機能を備えています。ダッシュボード機能により、登録済み端末数、利用可能な端末数、登録済みユーザー数をリアルタイムで表示します。端末管理機能では、全テスト端末の一覧表示、ステータス管理（利用可能・使用中）、CSV出力、および端末削除が可能です。ユーザー管理機能では、システムユーザーの一覧表示、ロール変更（管理者・一般ユーザー）、およびユーザー削除が実装されています。

---

## システムアーキテクチャ

### 技術スタック

| コンポーネント | 技術 | バージョン |
|---|---|---|
| フロントエンド | React | 19 |
| ビルドツール | Vite | 最新 |
| ルーティング | React Router | 6 |
| API通信 | tRPC | 最新 |
| スタイリング | CSS | カスタム |
| 認証 | OAuth 2.0 | Manus認証 |

### アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                    ブラウザ（ユーザー）                        │
└────────────────────────┬────────────────────────────────────┘
                         │
                    HTTP/HTTPS
                         │
┌────────────────────────▼────────────────────────────────────┐
│              WEB管理画面（React + Vite）                      │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  ページ: Login / Dashboard / Devices / Users         │   │
│  │  コンポーネント: Header / Sidebar / Table / Form     │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
                    tRPC API
                         │
┌────────────────────────▼────────────────────────────────────┐
│              バックエンドサーバー（Node.js）                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  ルーター: devices / users / auth                    │   │
│  │  ビジネスロジック: CRUD操作、権限チェック             │   │
│  └──────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
                    Firestore API
                         │
┌────────────────────────▼────────────────────────────────────┐
│                  Firestore（データベース）                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  コレクション: devices / users / logs                │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 認証とセキュリティ

### 認証フロー

WEB管理画面の認証は **OAuth 2.0** を採用しており、Manus認証サーバーを通じて実施されます。ユーザーがログインボタンをクリックすると、Manus認証ページにリダイレクトされます。ユーザーが認証情報を入力して認可すると、認可コードがコールバックURLに返されます。フロントエンドはこのコードをバックエンドに送信し、バックエンドがアクセストークンを取得します。最後に、アクセストークンをローカルストレージに保存し、以降のAPI呼び出しに使用します。

### セキュリティ対策

**認証トークン管理** では、アクセストークンはブラウザのローカルストレージに保存され、すべてのAPI呼び出しに自動的に付与されます。トークンの有効期限が切れた場合は、リフレッシュトークンを使用して新しいアクセストークンを取得します。

**HTTPS通信** により、すべての通信は暗号化されます。ブラウザとサーバー間、サーバーとFirestore間のすべての通信はHTTPSで保護されます。

**CORS設定** では、許可されたドメインからのリクエストのみを受け入れます。クロスオリジンリクエストは厳密に制限されます。

**権限チェック** は、バックエンド側で実施されます。各APIエンドポイントは、リクエスト元のユーザーロールを確認し、必要な権限がない場合は403エラーを返します。

---

## 画面構成

### ナビゲーション構造

```
ログイン画面
    ↓
ダッシュボード
    ├── 端末管理
    ├── ユーザー管理
    └── ログアウト
```

### 共通レイアウト

認証後のすべてのページは、以下の共通レイアウトを採用しています。ページ上部にはヘッダーが配置され、ユーザー情報とログアウトボタンが表示されます。左側にはサイドバーがあり、主要なナビゲーションメニュー（ダッシュボード、端末管理、ユーザー管理）が配置されています。メインコンテンツエリアには、各ページの固有のコンテンツが表示されます。

---

## 各画面の詳細仕様

### 1. ログイン画面（/login）

**目的** は、ユーザーの認証を実施することです。

**画面要素** は以下の通りです。ページタイトル「Device Manager」、サブタイトル「管理画面へログイン」、OAuth認証ボタン「Manusでログイン」が表示されます。

**ユーザー操作** では、ユーザーが「Manusでログイン」ボタンをクリックすると、Manus認証ページにリダイレクトされます。認証完了後、ダッシュボードに遷移します。

**遷移先** は、認証成功時にダッシュボード（/dashboard）に遷移し、既に認証済みの場合はダッシュボードに自動遷移します。

### 2. ダッシュボード画面（/dashboard）

**目的** は、システム全体の概要情報をリアルタイムで表示することです。

**画面要素** は以下の通りです。ページタイトル「ダッシュボード」、説明文「Device Manager 管理画面へようこそ」、3つの統計カード（登録済み端末数、利用可能な端末数、登録済みユーザー数）が表示されます。

**統計カード仕様** は以下の通りです。各カードには、アイコン、ラベル、数値が表示されます。登録済み端末カードは📱アイコンと端末総数を表示し、クリックで端末管理ページに遷移します。利用可能な端末カードは✅アイコンと利用可能な端末数を表示し、クリックで端末管理ページ（status=availableフィルタ付き）に遷移します。登録済みユーザーカードは👥アイコンとユーザー総数を表示し、クリックでユーザー管理ページに遷移します。

**データ取得** は、ページ読み込み時にバックエンドから端末情報とユーザー情報を取得します。読み込み中はローディングスピナーを表示します。

### 3. 端末管理画面（/devices）

**目的** は、テスト端末の一覧表示、検索、フィルタリング、および管理を実施することです。

**画面要素** は以下の通りです。ページタイトル「端末管理」、説明文「テスト端末の一覧と管理」、ステータスフィルタ（すべて・利用可能・使用中）、ソート機能付きテーブル、CSV出力ボタン、削除ボタンが配置されます。

**テーブル仕様** は以下の通りです。テーブルには、ID、機種名、OSバージョン、ステータス、作成日時、操作列が表示されます。各列はクリックでソート可能です。ステータス列には「利用可能」または「使用中」が表示されます。操作列には削除ボタンが配置されます。

**フィルタ機能** では、ステータスフィルタにより「すべて」「利用可能」「使用中」から選択可能です。フィルタ変更時にテーブルが自動更新されます。

**CSV出力機能** では、CSV出力ボタンをクリックすると、現在のフィルタ条件に基づいたデータをCSV形式でダウンロードできます。ファイル名は「devices_YYYY-MM-DD.csv」形式です。

**削除機能** では、各行の削除ボタンをクリックすると確認ダイアログが表示されます。確認後、該当端末がシステムから削除されます。削除は管理者のみ可能です。

### 4. ユーザー管理画面（/users）

**目的** は、システムユーザーの一覧表示、ロール管理、および削除を実施することです。

**画面要素** は以下の通りです。ページタイトル「ユーザー管理」、説明文「システムユーザーの一覧と管理」、ロールフィルタ（すべて・管理者・ユーザー）、ソート機能付きテーブルが配置されます。

**テーブル仕様** は以下の通りです。テーブルには、ID、名前、メール、ロール、作成日時が表示されます。各列はクリックでソート可能です。ロール列にはドロップダウンセレクトボックスが配置され、「ユーザー」または「管理者」を選択できます。

**ロール変更機能** では、ロール列のドロップダウンから新しいロールを選択すると、バックエンドに更新リクエストが送信されます。更新成功時は成功メッセージが表示され、失敗時はエラーメッセージが表示されます。ロール変更は管理者のみ可能です。

**フィルタ機能** では、ロールフィルタにより「すべて」「管理者」「ユーザー」から選択可能です。フィルタ変更時にテーブルが自動更新されます。

**権限制御** では、ロール変更・削除操作は管理者のみが実行可能です。一般ユーザーがこれらの操作を試みた場合、エラーメッセージが表示されます。

---

## API仕様

### 認証API

#### OAuth認証

**エンドポイント：** `POST /api/auth/oauth/callback`

**説明：** OAuth認可コードをアクセストークンに交換します。

**リクエストボディ：**
```json
{
  "code": "authorization_code",
  "state": "state_parameter"
}
```

**レスポンス：**
```json
{
  "accessToken": "token_string",
  "refreshToken": "refresh_token_string",
  "user": {
    "id": "user_id",
    "email": "user@example.com",
    "name": "User Name",
    "role": "admin"
  }
}
```

### 端末API

#### 端末一覧取得

**エンドポイント：** `GET /api/trpc/devices.list`

**説明：** すべての端末情報を取得します。

**レスポンス：**
```json
[
  {
    "id": 1,
    "name": "iPhone 15 Pro",
    "osVersion": "iOS 17.2",
    "status": "available",
    "createdAt": "2025-12-22T09:12:34Z"
  }
]
```

#### 端末削除

**エンドポイント：** `POST /api/trpc/devices.delete`

**説明：** 指定IDの端末を削除します。管理者のみ実行可能です。

**リクエストボディ：**
```json
{
  "id": 1
}
```

**レスポンス：**
```json
{
  "success": true,
  "message": "Device deleted successfully"
}
```

#### CSV出力

**エンドポイント：** `GET /api/trpc/devices.csv`

**説明：** 端末情報をCSV形式で取得します。

**レスポンス：** CSV形式のテキストデータ

### ユーザーAPI

#### ユーザー一覧取得

**エンドポイント：** `GET /api/trpc/users.list`

**説明：** すべてのユーザー情報を取得します。

**レスポンス：**
```json
[
  {
    "id": 1,
    "name": "Kazuhiko Yokoyama",
    "email": "yokoyama@eightdoor.co.jp",
    "role": "admin",
    "createdAt": "2025-12-22T09:12:34Z"
  }
]
```

#### ロール変更

**エンドポイント：** `POST /api/trpc/users.updateRole`

**説明：** 指定ユーザーのロールを変更します。管理者のみ実行可能です。

**リクエストボディ：**
```json
{
  "userId": 1,
  "email": "user@example.com",
  "role": "admin"
}
```

**レスポンス：**
```json
{
  "success": true,
  "message": "Role updated successfully"
}
```

#### ユーザー削除

**エンドポイント：** `POST /api/trpc/users.delete`

**説明：** 指定IDのユーザーを削除します。管理者のみ実行可能です。

**リクエストボディ：**
```json
{
  "id": 1
}
```

**レスポンス：**
```json
{
  "success": true,
  "message": "User deleted successfully"
}
```

---

## データベース仕様

### Firestoreコレクション構造

#### devicesコレクション

端末情報を保存するコレクションです。

| フィールド名 | 型 | 説明 | 例 |
|---|---|---|---|
| id | number | 端末ID（自動採番） | 1 |
| name | string | 端末機種名 | iPhone 15 Pro |
| osVersion | string | OSバージョン | iOS 17.2 |
| status | string | 利用状況（available/in_use） | available |
| createdAt | timestamp | 作成日時 | 2025-12-22T09:12:34Z |
| updatedAt | timestamp | 更新日時 | 2025-12-22T09:12:34Z |

#### usersコレクション

ユーザー情報を保存するコレクションです。

| フィールド名 | 型 | 説明 | 例 |
|---|---|---|---|
| id | string | ユーザーID（Firestore自動生成） | abc123def456 |
| name | string | ユーザー名 | Kazuhiko Yokoyama |
| email | string | メールアドレス | yokoyama@eightdoor.co.jp |
| role | string | ロール（admin/user） | admin |
| createdAt | timestamp | 作成日時 | 2025-12-22T09:12:34Z |
| updatedAt | timestamp | 更新日時 | 2026-01-13T19:53:34Z |

---

## ユーザーロール権限

### ロール種別

WEB管理画面では、2つのユーザーロールが定義されています。

#### 管理者（Admin）

管理者ロールは、システムのすべての機能にアクセス可能です。具体的には、端末情報の閲覧・削除、ユーザー情報の閲覧・ロール変更・削除、ダッシュボードの閲覧が可能です。

#### 一般ユーザー（User）

一般ユーザーロールは、読み取り専用の機能にのみアクセス可能です。具体的には、端末情報の閲覧、ユーザー情報の閲覧、ダッシュボードの閲覧が可能ですが、削除やロール変更は実行できません。

### 権限マトリックス

| 操作 | 管理者 | 一般ユーザー |
|---|---|---|
| ダッシュボード表示 | ✅ | ✅ |
| 端末一覧表示 | ✅ | ✅ |
| 端末削除 | ✅ | ❌ |
| CSV出力 | ✅ | ✅ |
| ユーザー一覧表示 | ✅ | ✅ |
| ロール変更 | ✅ | ❌ |
| ユーザー削除 | ✅ | ❌ |

### 現在の管理者ユーザー

以下のユーザーは管理者ロールで登録されています。

- yokoyama@eightdoor.co.jp（横山和彦）
- info@eightdoor.co.jp（情報システム）

---

## トラブルシューティング

### ページが開けない場合

ブラウザキャッシュをクリアしてください。キャッシュが古い状態の場合、ページが正常に読み込まれない可能性があります。`Ctrl + Shift + Delete`でブラウザキャッシュをクリアし、`Ctrl + Shift + R`でページを完全リロードしてください。

### 認証エラーが表示される場合

ログイン情報を確認してください。メールアドレスとパスワードが正しいか確認してください。また、認証トークンの有効期限が切れている可能性があります。ページをリロードして再度ログインしてください。

### データが表示されない場合

ネットワーク接続を確認してください。インターネット接続が正常であることを確認してください。また、ブラウザの開発者ツール（F12）でコンソールを確認し、エラーメッセージがないか確認してください。

### 操作が実行されない場合

権限を確認してください。実行しようとしている操作が、現在のユーザーロールで許可されているか確認してください。管理者のみが実行可能な操作については、管理者ユーザーでログインしてください。

---

## 今後の拡張予定

### 短期（1-2ヶ月）

- 設定画面の実装（組織情報、貸出ルール等）
- 端末詳細ページの実装
- 貸出・返却ワークフローの実装

### 中期（3-6ヶ月）

- 貸出履歴レポート機能
- ユーザーインポート機能（CSV一括登録）
- 通知機能（貸出期限切れアラート等）

### 長期（6ヶ月以上）

- モバイルアプリ連携
- API統合（外部システムとの連携）
- 監査ログ機能の強化

---

**ドキュメント終了**
